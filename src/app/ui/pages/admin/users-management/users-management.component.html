<div class="min-h-screen bg-linear-to-br from-purple-50 to-blue-50">
  <app-admin-page-header title="Manage Users"></app-admin-page-header>

  <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <app-alert
      *ngIf="successMessage()"
      [message]="successMessage()"
      type="success"
      (close)="successMessage.set('')"
    ></app-alert>

    <app-alert
      *ngIf="errorMessage()"
      [message]="errorMessage()"
      type="error"
      (close)="errorMessage.set('')"
    ></app-alert>

    <!-- Main Content -->
    <app-management-list
      title="Users"
      itemLabel="User"
      [isLoading]="isLoading()"
      [isEmpty]="users().length === 0"
      (add)="openAddUserModal()"
    >
      <div
        class="bg-white/60 backdrop-blur-md rounded-xl shadow-sm overflow-hidden border border-white/40"
      >
        <table class="w-full">
          <thead class="bg-white/40 border-b border-white/20">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
              >
                Username
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
              >
                Email
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
              >
                Role
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
              >
                Status
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
              >
                Owner
              </th>
              <th
                class="px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/20">
            @for (user of users(); track user.id) {
              <tr class="hover:bg-white/40 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="font-medium text-gray-900">{{ user.name }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  {{ user.email || 'N/A' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span
                    class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100/80 text-blue-800 border border-blue-200"
                  >
                    {{ getRoleDisplay(user.roleId) }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  @if (user.active) {
                    <span
                      class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100/80 text-green-800 border border-green-200"
                    >
                      Active
                    </span>
                  } @else {
                    <span
                      class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100/80 text-red-800 border border-red-200"
                    >
                      Inactive
                    </span>
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  @if (user.isOwner) {
                    <span class="text-yellow-600 font-semibold">ðŸ‘‘ Owner</span>
                  } @else {
                    <span class="text-gray-400">â€”</span>
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex justify-end gap-3">
                    <button
                      (click)="openEditUserModal(user)"
                      class="text-blue-600 hover:text-blue-900 transition-colors"
                    >
                      Edit
                    </button>
                    @if (!user.isOwner && currentUserIsOwner()) {
                      <button
                        (click)="onDeleteUser(user)"
                        class="text-red-600 hover:text-red-900 transition-colors"
                      >
                        Delete
                      </button>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </app-management-list>

    <!-- Add User Modal -->
    <app-modal *ngIf="showAddUserModal()" (close)="closeAddUserModal()">
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Add New User</h2>
          <button (click)="closeAddUserModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
            Ã—
          </button>
        </div>

        <form (ngSubmit)="onAddUser()" class="space-y-4">
          <div>
            <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">
              Username *
            </label>
            <input
              appAutoFocus
              type="text"
              id="userName"
              [value]="newUserName()"
              (input)="newUserName.set($any($event.target).value)"
              class="w-full px-4 py-2 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
              placeholder="username"
              required
            />
          </div>

          <div>
            <label for="userPin" class="block text-sm font-medium text-gray-700 mb-1">
              PIN (4+ digits) *
            </label>
            <input
              type="password"
              id="userPin"
              [value]="newUserPin()"
              (input)="newUserPin.set($any($event.target).value)"
              class="w-full px-4 py-2 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
              placeholder="****"
              required
              minlength="4"
            />
          </div>

          <div>
            <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">
              Role *
            </label>
            <select
              id="userRole"
              [value]="newUserRole()"
              (change)="newUserRole.set($any($event.target).value)"
              class="w-full px-4 py-2 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
              required
            >
              <option value="ADMIN">Admin</option>
              <option value="CASHIER">Cashier</option>
              <option value="KITCHEN">Kitchen</option>
            </select>
          </div>

          <div class="flex gap-3 pt-2">
            <button
              type="button"
              (click)="closeAddUserModal()"
              class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="isLoading()"
              class="flex-1 px-4 py-2 bg-linear-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white rounded-lg transition-colors shadow-md disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed"
            >
              @if (isLoading()) {
                <span>Adding...</span>
              } @else {
                <span>Add User</span>
              }
            </button>
          </div>
        </form>
      </div>
    </app-modal>

    <!-- Edit User Modal -->
    <app-modal *ngIf="showEditUserModal()" (close)="closeEditUserModal()">
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Edit User</h2>
          <button (click)="closeEditUserModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
            Ã—
          </button>
        </div>

        <form (ngSubmit)="onUpdateUser()" class="space-y-4">
          <div>
            <label for="editUserName" class="block text-sm font-medium text-gray-700 mb-1">
              Name *
            </label>
            <input
              appAutoFocus
              type="text"
              id="editUserName"
              [value]="editUserName()"
              (input)="editUserName.set($any($event.target).value)"
              class="w-full px-4 py-2 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
              required
            />
          </div>

          <div>
            <label for="editUserEmail" class="block text-sm font-medium text-gray-700 mb-1">
              Email
            </label>
            <input
              type="email"
              id="editUserEmail"
              [value]="editUserEmail()"
              (input)="editUserEmail.set($any($event.target).value)"
              class="w-full px-4 py-2 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
            />
          </div>

          <div>
            <label for="editUserPin" class="block text-sm font-medium text-gray-700 mb-1">
              New PIN (Leave blank to keep current)
            </label>
            <input
              type="password"
              id="editUserPin"
              [value]="editUserPin()"
              (input)="editUserPin.set($any($event.target).value)"
              class="w-full px-4 py-2 bg-white/60 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
              placeholder="****"
              minlength="4"
            />
          </div>

          <div class="flex gap-3 pt-2">
            <button
              type="button"
              (click)="closeEditUserModal()"
              class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="isLoading()"
              class="flex-1 px-4 py-2 bg-linear-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white rounded-lg transition-colors shadow-md disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed"
            >
              @if (isLoading()) {
                <span>Updating...</span>
              } @else {
                <span>Save Changes</span>
              }
            </button>
          </div>
        </form>
      </div>
    </app-modal>

    <!-- Delete Confirmation -->
    <app-confirm-delete-modal
      *ngIf="isDeleteConfirmOpen"
      [itemName]="deleteConfirmName"
      (confirm)="confirmDelete()"
      (cancel)="closeDeleteConfirm()"
    ></app-confirm-delete-modal>
  </main>
</div>
