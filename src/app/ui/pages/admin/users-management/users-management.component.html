<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
  @if (successMessage()) {
    <app-alert
      [message]="successMessage()"
      type="success"
      (close)="successMessage.set('')"
    ></app-alert>
  }

  @if (errorMessage()) {
    <app-alert [message]="errorMessage()" type="error" (close)="errorMessage.set('')"></app-alert>
  }

  <!-- Main Content -->
  <app-management-list
    title="Users"
    itemLabel="User"
    [isLoading]="isLoading()"
    [isEmpty]="users().length === 0"
    (add)="openAddUserModal()"
  >
    <div
      class="bg-white/60 backdrop-blur-md rounded-xl shadow-sm overflow-hidden border border-white/40"
    >
      <table class="w-full">
        <thead class="bg-white/40 border-b border-white/20">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
            >
              Username
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
            >
              Email
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
            >
              Role
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
            >
              Status
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
            >
              Owner
            </th>
            <th
              class="px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-white/20">
          @for (user of users(); track user.id) {
            <tr class="hover:bg-white/40 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-medium text-gray-900">{{ user.name }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                {{ user.email || 'N/A' }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100/80 text-blue-800 border border-blue-200"
                >
                  {{ getRoleDisplay(user.roleId) }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                @if (user.active) {
                  <span
                    class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100/80 text-green-800 border border-green-200"
                  >
                    Active
                  </span>
                } @else {
                  <span
                    class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100/80 text-red-800 border border-red-200"
                  >
                    Inactive
                  </span>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                @if (user.isOwner) {
                  <span class="text-yellow-600 font-semibold">ðŸ‘‘ Owner</span>
                } @else {
                  <span class="text-gray-400">â€”</span>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-3">
                  <button
                    (click)="openEditUserModal(user)"
                    class="text-blue-600 hover:text-blue-900 transition-colors"
                  >
                    Edit
                  </button>
                  @if (!user.isOwner && currentUserIsOwner()) {
                    <button
                      (click)="onDeleteUser(user)"
                      class="text-red-600 hover:text-red-900 transition-colors"
                    >
                      Delete
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </app-management-list>

  <!-- Add User Modal -->
  @if (showAddUserModal()) {
    <app-modal
      (close)="closeAddUserModal()"
      title="Add New User"
      subtitle="Create a new internal account for staff members"
    >
      <form id="addUserForm" (ngSubmit)="onAddUser()" class="space-y-6 px-1">
        <div>
          <label
            for="userName"
            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2"
          >
            Username *
          </label>
          <input
            appAutoFocus
            type="text"
            id="userName"
            [value]="newUserName()"
            (input)="newUserName.set($any($event.target).value)"
            class="w-full px-5 py-3 min-h-[44px] backdrop-blur-md bg-white/50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 transition-all font-medium text-gray-800"
            placeholder="username"
            required
          />
        </div>

        <div>
          <label
            for="userPin"
            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2"
          >
            PIN (4+ digits) *
          </label>
          <input
            type="password"
            id="userPin"
            [value]="newUserPin()"
            (input)="newUserPin.set($any($event.target).value)"
            class="w-full px-5 py-3 min-h-[44px] backdrop-blur-md bg-white/50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 transition-all font-medium text-gray-800"
            placeholder="****"
            required
            minlength="4"
          />
        </div>

        <div>
          <label
            for="userRole"
            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2"
          >
            Role *
          </label>
          <select
            id="userRole"
            [value]="newUserRole()"
            (change)="newUserRole.set($any($event.target).value)"
            class="w-full px-5 py-3 min-h-[44px] backdrop-blur-md bg-white/50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 transition-all font-medium text-gray-800"
            required
          >
            <option value="ADMIN">Admin</option>
            <option value="CASHIER">Cashier</option>
            <option value="KITCHEN">Kitchen</option>
          </select>
        </div>
      </form>

      <div footer class="flex gap-4 w-full">
        <button
          type="button"
          (click)="closeAddUserModal()"
          class="flex-1 px-6 py-3 min-h-[44px] bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-2xl transition-all font-black uppercase tracking-widest text-xs active:scale-95"
        >
          Cancel
        </button>
        <button
          form="addUserForm"
          type="submit"
          [disabled]="isLoading()"
          class="flex-1 px-6 py-3 min-h-[44px] bg-linear-to-r from-purple-600 to-blue-600 hover:shadow-xl hover:shadow-purple-200 text-white rounded-2xl transition-all font-black uppercase tracking-widest text-xs active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          @if (isLoading()) {
            <span>Adding...</span>
          } @else {
            <span>Add User</span>
          }
        </button>
      </div>
    </app-modal>
  }

  <!-- Edit User Modal -->
  @if (showEditUserModal()) {
    <app-modal
      (close)="closeEditUserModal()"
      title="Edit User"
      subtitle="Update staff account information and security"
    >
      <form id="editUserForm" (ngSubmit)="onUpdateUser()" class="space-y-6 px-1">
        <div>
          <label
            for="editUserName"
            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2"
          >
            Name *
          </label>
          <input
            appAutoFocus
            type="text"
            id="editUserName"
            [value]="editUserName()"
            (input)="editUserName.set($any($event.target).value)"
            class="w-full px-5 py-3 min-h-[44px] backdrop-blur-md bg-white/50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 transition-all font-medium text-gray-800"
            required
          />
        </div>

        <div>
          <label
            for="editUserEmail"
            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2"
          >
            Email
          </label>
          <input
            type="email"
            id="editUserEmail"
            [value]="editUserEmail()"
            (input)="editUserEmail.set($any($event.target).value)"
            class="w-full px-5 py-3 min-h-[44px] backdrop-blur-md bg-white/50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 transition-all font-medium text-gray-800"
          />
        </div>

        <div>
          <label
            for="editUserPin"
            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2"
          >
            New PIN (Leave blank to keep current)
          </label>
          <input
            type="password"
            id="editUserPin"
            [value]="editUserPin()"
            (input)="editUserPin.set($any($event.target).value)"
            class="w-full px-5 py-3 min-h-[44px] backdrop-blur-md bg-white/50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 transition-all font-medium text-gray-800"
            placeholder="****"
            minlength="4"
          />
        </div>
      </form>

      <div footer class="flex gap-4 w-full">
        <button
          type="button"
          (click)="closeEditUserModal()"
          class="flex-1 px-6 py-3 min-h-[44px] bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-2xl transition-all font-black uppercase tracking-widest text-xs active:scale-95"
        >
          Cancel
        </button>
        <button
          form="editUserForm"
          type="submit"
          [disabled]="isLoading()"
          class="flex-1 px-6 py-3 min-h-[44px] bg-linear-to-r from-purple-600 to-blue-600 hover:shadow-xl hover:shadow-purple-200 text-white rounded-2xl transition-all font-black uppercase tracking-widest text-xs active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          @if (isLoading()) {
            <span>Updating...</span>
          } @else {
            <span>Save Changes</span>
          }
        </button>
      </div>
    </app-modal>
  }

  <!-- Delete Confirmation -->
  @if (isDeleteConfirmOpen) {
    <app-confirm-delete-modal
      [itemName]="deleteConfirmName"
      (confirm)="confirmDelete()"
      (cancel)="closeDeleteConfirm()"
    ></app-confirm-delete-modal>
  }
</main>
