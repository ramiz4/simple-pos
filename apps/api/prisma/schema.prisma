generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String
  subdomain          String    @unique
  customDomain       String?   @unique
  customDomainStatus String    @default("NOT_CONFIGURED")
  customDomainVerificationToken String?
  customDomainVerifiedAt DateTime?
  plan               String    @default("FREE")
  status             String    @default("ACTIVE")
  stripeCustomerId   String?   @unique
  stripeSubscriptionId String? @unique
  subscriptionStatus String?
  trialEndsAt        DateTime?
  currentPeriodEndsAt DateTime?
  subscriptionEndsAt DateTime?
  maxUsers           Int       @default(2)
  maxLocations       Int       @default(1)
  maxDevices         Int       @default(1)
  features           String[]  @default([])
  // Settings as JSON
  settings           Json?
  billingInfo        Json?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  products Product[]
  orders   Order[]
  customers Customer[]
  users    User[]
  syncDocuments SyncDocument[]
  syncConflicts SyncConflict[]
  apiKeys  TenantApiKey[]
  billingEvents BillingEvent[]
  ssoProviders SsoProvider[]
  professionalServiceRequests ProfessionalServiceRequest[]

  @@map("tenants")
}

model TenantApiKey {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  keyPrefix   String
  keyHash     String
  lastUsedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, revokedAt])
  @@index([keyPrefix])
  @@map("tenant_api_keys")
}

model BillingEvent {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String?  @db.Uuid
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  stripeEventId String   @unique
  eventType     String
  livemode      Boolean  @default(false)
  payload       Json
  processedAt   DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([tenantId, processedAt])
  @@index([eventType, processedAt])
  @@map("billing_events")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  email     String   @unique
  firstName String
  lastName  String
  role      String   @default("CASHIER")
  pinHash   String?
  password  String? // Nullable if using PIN only locally, but cloud needs auth
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  professionalServiceRequests ProfessionalServiceRequest[] @relation("ProfessionalServiceRequestedBy")

  @@map("users")
}

model SsoProvider {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name             String
  slug             String
  protocol         String
  enabled          Boolean  @default(true)
  authorizationUrl String?
  tokenUrl         String?
  userInfoUrl      String?
  issuer           String?
  entryPoint       String?
  callbackUrl      String?
  clientId         String?
  clientSecret     String?
  scopes           String[] @default([])
  roleMappings     Json?
  claimMapping     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId, enabled])
  @@map("sso_providers")
}

model ProfessionalServiceRequest {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @db.Uuid
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requestedByUserId String?  @db.Uuid
  requestedByUser   User?    @relation("ProfessionalServiceRequestedBy", fields: [requestedByUserId], references: [id], onDelete: SetNull)
  requesterEmail    String
  category          String
  priority          String   @default("NORMAL")
  status            String   @default("OPEN")
  title             String
  description       String
  preferredContact  Json?
  assignedTo        String?
  internalNotes     Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  resolvedAt        DateTime?

  @@index([tenantId, status, createdAt])
  @@index([status, createdAt])
  @@map("professional_service_requests")
}

model Product {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @db.Uuid
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  localId       Int? // ID from the local SQLite DB
  name          String
  description   String?
  price         Decimal   @db.Decimal(10, 2)
  categoryId    String?   @db.Uuid
  stockQuantity Int       @default(0)
  isActive      Boolean   @default(true)
  version       Int       @default(1)
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  syncedAt      DateTime?

  orderItems    OrderItem[]

  @@index([tenantId])
  @@map("products")
}

model Customer {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @db.Uuid
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  localId       Int?
  firstName     String
  lastName      String?
  email         String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  version       Int       @default(1)
  syncedAt      DateTime?

  orders        Order[]

  @@index([tenantId])
  @@map("customers")
}

model Order {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  localId     Int?
  orderNumber String?
  status      String
  type        String    @default("DINE_IN")
  subtotal    Decimal   @default(0) @db.Decimal(10, 2)
  tax         Decimal   @default(0) @db.Decimal(10, 2)
  tip         Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)

  customerId  String?   @db.Uuid
  customer    Customer? @relation(fields: [customerId], references: [id])

  userId      String?   @db.Uuid
  user        User?     @relation(fields: [userId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  version     Int       @default(1)
  syncedAt    DateTime?

  items       OrderItem[]

  @@index([tenantId])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid()) @db.Uuid
  orderId     String   @db.Uuid
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String   @db.Uuid
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  tenantId    String   @db.Uuid

  @@index([tenantId])
  @@map("order_items")
}

model SyncDocument {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  entity         String
  cloudId        String
  localId        String?
  deviceId       String?
  data           Json
  version        Int      @default(1)
  isDeleted      Boolean  @default(false)
  syncedAt       DateTime?
  lastModifiedAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([tenantId, entity, cloudId])
  @@index([tenantId, entity, updatedAt])
  @@index([tenantId, entity, localId])
  @@map("sync_documents")
}

model SyncConflict {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  entity        String
  cloudId       String
  localId       String?
  strategy      String
  serverVersion Int
  clientVersion Int
  serverData    Json
  clientData    Json
  resolved      Boolean  @default(false)
  resolvedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId, resolved, createdAt])
  @@index([tenantId, entity, cloudId])
  @@map("sync_conflicts")
}
